SYSTEM:
	SSH:
		touch /boot/ssh
	WIFI:
	    https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md
	    https://medium.com/@markus.andor/raspberry-pi-4-network-configuration-ca25e56e9e1e
	    sudo nano /etc/wpa_supplicant/wpa_supplicant.conf
	DJANGO:
	    DJANGO:
            sudo mkdir -p /data/django
            source /data/venv/bin/activate
            pip install django
            cd /data/django
            django-admin startproject jukeoroni
        APACHE: (NGINX? THTTPD?)
            https://pimylifeup.com/raspberry-pi-django/

                sudo apt install apache2
                sudo apt-get install apache2-dev

                sudo usermod -a -G www-data pi
                sudo chown -R -f www-data:www-data /var/www/html

                sudo apt install libapache2-mod-wsgi-py3 (this might not be working, see SO link)

            https://stackoverflow.com/questions/33320889/invalid-command-wsgidaemonprocess-deploy-django-application-on-centos-6-7


                sudo apt-get remove libapache2-mod-wsgi

                sudo apt-get remove libapache2-mod-wsgi-py3
                sudo apt-get install apache2-dev

                pip install mod_wsgi

                mod_wsgi-express module-config
                    LoadModule wsgi_module "/data/venv/lib/python3.7/site-packages/mod_wsgi/server/mod_wsgi-py37.cpython-37m-arm-linux-gnueabihf.so"
                    WSGIPythonHome "/data/venv"

                    >> sudo nano /etc/apache2/mods-available/wsgi.load
                sudo a2enmod wsgi

                sudo systemctl reload apache2
                # sudo chown -R www-data:www-data /data/django/jukeoroni/
                sudo systemctl restart apache2
                sudo systemctl enable apache2

                sudo nano /data/django/jukeoroni/jukeoroni/settings.py
                    ALLOWED_HOSTS = ['*']

                TREE:
                    (venv) pi@jukeoroni:/ $ tree /data/django/
                    /data/django/
                    └── jukeoroni
                        ├── db.sqlite3
                        ├── jukeoroni
                        │        ├── asgi.py
                        │        ├── __init__.py
                        │        ├── settings.py
                        │        ├── urls.py
                        │        └── wsgi.py
                        ├── manage.py
                        └── static

                    sudo chown -R www-data:www-data /data/django/jukeoroni/

                    sudo nano /etc/apache2/sites-enabled/000-default.conf:
                        <VirtualHost *:80>
                            # The ServerName directive sets the request scheme, hostname and port that
                            # the server uses to identify itself. This is used when creating
                            # redirection URLs. In the context of virtual hosts, the ServerName
                            # specifies what hostname must appear in the request's Host: header to
                            # match this virtual host. For the default virtual host (this file) this
                            # value is not decisive as it is used as a last resort host regardless.
                            # However, you must set it for any further virtual host explicitly.
                            #ServerName www.example.com

                            ServerAdmin webmaster@localhost
                            DocumentRoot /var/www/html

                            # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
                            # error, crit, alert, emerg.
                            # It is also possible to configure the loglevel for particular
                            # modules, e.g.
                            #LogLevel info ssl:warn

                            ErrorLog ${APACHE_LOG_DIR}/error.log
                            CustomLog ${APACHE_LOG_DIR}/access.log combined

                            # For most configuration files from conf-available/, which are
                            # enabled or disabled at a global level, it is possible to
                            # include a line for only one particular virtual host. For example the
                            # following line enables the CGI configuration for this host only
                            # after it has been globally disabled with "a2disconf".
                            #Include conf-available/serve-cgi-bin.conf

                            #Alias /static /data/django/jukeoroni/static/
                            Alias /static /data/venv/lib/python3.7/site-packages/django/contrib/admin/static
                            <Directory /data/django/jukeoroni/static>
                                    Require all granted
                            </Directory>

                            <Directory /data/venv/lib/python3.7/site-packages/django/contrib>
                                    Require all granted
                            </Directory>

                            <Directory /data/django/jukeoroni/jukeoroni>
                                    <Files wsgi.py>
                                            Require all granted
                                    </Files>
                            </Directory>

                            WSGIDaemonProcess django python-path=/data/django/jukeoroni python-home=/data/venv
                            WSGIProcessGroup django
                            WSGIScriptAlias / /data/django/jukeoroni/jukeoroni/wsgi.py

                        </VirtualHost>

                        # vim: syntax=apache ts=4 sw=4 sts=4 sr noet



                    # change user for apache process, www-data won't have access to pulse-audio
                    sudo nano /etc/apache2/envvars
                        #export APACHE_RUN_USER=www-data
                        #export APACHE_RUN_GROUP=www-data
                        export APACHE_RUN_USER=pi
                        export APACHE_RUN_GROUP=pi


OR sudo raspi-config

sudo apt-get update
sudo apt-get upgrade
sudo apt autoremove

fix:
	perl: warning: Setting locale failed.
	perl: warning: Please check that your locale settings:
		LANGUAGE = (unset),
		LC_ALL = (unset),
		LC_CTYPE = "UTF-8",
		LANG = "en_GB.UTF-8"
	    are supported and installed on your system.
	perl: warning: Falling back to a fallback locale ("en_GB.UTF-8").
with:
	localisation in raspi-config: en_US.UTF-8 UTF-8
not working? try:
	# https://raspberrypi.stackexchange.com/questions/38019/locale-settings-issues
		sudo nano /etc/default/locale

		LANG=en_US.UTF-8
		LC_ALL=en_US.UTF-8
		LANGUAGE=en_US.UTF-8



TRANSMISSION:
	# https://pimylifeup.com/raspberry-pi-transmission/

    sudo apt install transmission-daemon

    sudo systemctl status transmission-daemon

    sudo systemctl stop transmission-daemon

	sudo nano /etc/systemd/system/multi-user.target.wants/transmission-daemon.service
	# add googledrive.service dependency and change user
		[Unit]
		Description=Transmission BitTorrent Daemon
		After=network.target googledrive.service

		[Service]
		User=pi
		Type=notify
		ExecStartPre=/bin/sleep 15
		ExecStart=nice -10 /usr/bin/transmission-daemon -f --log-error
		ExecStop=/bin/kill -s STOP $MAINPID
		ExecReload=/bin/kill -s HUP $MAINPID

		[Install]
		WantedBy=multi-user.target

	transmission-daemon??
	service: /lib/systemd/system/transmission-daemon.service

	sudo mkdir -p /data/transmission/in_progress
	sudo chown -R pi:pi /data/transmission/in_progress

	pi@raspberrypi:~ $ sudo nano /etc/transmission-daemon/settings.json
{
    "alt-speed-down": 512,
    "alt-speed-enabled": false,
    "alt-speed-time-begin": 540,
    "alt-speed-time-day": 127,
    "alt-speed-time-enabled": false,
    "alt-speed-time-end": 1020,
    "alt-speed-up": 0,
    "bind-address-ipv4": "0.0.0.0",
    "bind-address-ipv6": "::",
    "blocklist-enabled": false,
    "blocklist-url": "http://www.example.com/blocklist",
    "cache-size-mb": 4,
    "dht-enabled": true,
    "download-dir": "/data/googledrive/media/torrents",
    "download-limit": 100,
    "download-limit-enabled": 0,
    "download-queue-enabled": true,
    "download-queue-size": 5,
    "encryption": 1,
    "idle-seeding-limit": 30,
    "idle-seeding-limit-enabled": false,
    "incomplete-dir": "/data/transmission/in_progress",
    "incomplete-dir-enabled": true,
    "lpd-enabled": false,
    "max-peers-global": 200,
    "message-level": 1,
    "peer-congestion-algorithm": "",
    "peer-id-ttl-hours": 6,
    "peer-limit-global": 200,
    "peer-limit-per-torrent": 50,
    "peer-port": 51413,
    "peer-port-random-high": 65535,
    "peer-port-random-low": 49152,
    "peer-port-random-on-start": false,
    "peer-socket-tos": "default",
    "pex-enabled": true,
    "port-forwarding-enabled": false,
    "preallocation": 1,
    "prefetch-enabled": true,
    "queue-stalled-enabled": true,
    "queue-stalled-minutes": 30,
    "ratio-limit": 2,
    "ratio-limit-enabled": false,
    "rename-partial-files": true,
    "rpc-authentication-required": true,
    "rpc-bind-address": "0.0.0.0",
    "rpc-enabled": true,
    "rpc-host-whitelist": "",
    "rpc-host-whitelist-enabled": true,
    "rpc-password": "transmission",
    "rpc-port": 9091,
    "rpc-url": "/transmission/",
    "rpc-username": "transmission",
    "rpc-whitelist": "127.0.0.1",
    "rpc-whitelist-enabled": false,
    "scrape-paused-torrents-enabled": true,
    "script-torrent-done-enabled": false,
    "script-torrent-done-filename": "/data/transmission/script_torrent_done.sh",
    "seed-queue-enabled": false,
    "seed-queue-size": 10,
    "speed-limit-down": 512,
    "speed-limit-down-enabled": false,
    "speed-limit-up": 0,
    "speed-limit-up-enabled": true,
    "start-added-torrents": true,
    "trash-original-torrent-files": false,
    "umask": 18,
    "upload-limit": 0,
    "upload-limit-enabled": 1,
    "upload-slots-per-torrent": 14,
    "utp-enabled": true
}

	sudo nano /etc/init.d/transmission-daemon
	USER=debian-transmission => USER=pi

	# remove data and torrent:
	# transmission-remote -n 'transmission:transmission' -t 1 -rad

	sudo mkdir -p /home/pi/.config/transmission-daemon/
	sudo ln -s /etc/transmission-daemon/settings.json /home/pi/.config/transmission-daemon/
	sudo chown -R pi:pi /home/pi/.config/transmission-daemon/

	sudo chown -R pi:pi /etc/transmission-daemon

	pi@raspberrypi:~ $ sudo service transmission-daemon stop
	pi@raspberrypi:~ $ sudo systemctl daemon-reload
	sudo systemctl enable transmission-daemon
	sudo systemctl start transmission-daemon
	# pi@raspberrypi:~ $ sudo service transmission-daemon start


IQAUDIO DAC PRO:
	IQAUDIO:
		https://datasheets.raspberrypi.org/iqaudio/iqaudio-product-brief.pdf

		sudo nano /boot/config.txt

		if grep -q "^dtparam=audio=on" /boot/config.txt; then
		    sudo sed -i "/^dtparam=audio=on$/ s|^|#|" sudo nano /boot/config.txt

        # speaker-test:
        # speaker-test /usr/share/sounds/alsa/Front_Center.wav
		dtparam=audio=on => #dtparam=audio=on

	HIFIBERRY DAC2HD?
	- IFI Power supply
	BOSS 1.2?
	- power supply: ??


PYTHON:
	PIP:
		sudo apt-get install python3-pip
		python3-pipdeptree: ??

		pip3 install --upgrade setuptools
		pip3 install --upgrade pip
	VENV:
		https://www.techcoil.com/blog/how-to-use-python-3-virtual-environments-to-run-python-3-applications-on-your-raspberry-pi/

		sudo apt-get install python3-venv
	CREATE VENV:
		# mkdir /home/pi/venv
		# python3 -m venv ~/venv
		python3 -m venv /data/venv

	PIMORONI:
		https://shop.pimoroni.com/products/inky-impression

		# global (not in venv):
		# i don't like to use this script!!!
		curl https://get.pimoroni.com/inky | bash
	MY APPROACH:
	    FOR:
	        python3.7
            uname -m
                armv7l
            cat /etc/os-release | grep -q "buster"
                "true"

        # install .deb:
            sudo apt-get --yes install .deb
        # install .pkg
            sudo dpkg -i /tempdir/.pgk


	    sudo raspi-config nonint do_spi 0
	    # or?: dtparam=spi=on
	    sudo raspi-config nonint do_i2c 0
	    # or?: dtparam=i2c_arm=on
	    DEPS DEB:
            # SMBUS3="python3-smbus_3.1.1+svn-2_armhf.deb"
            # SPIDEV3="python3-spidev_2.0~git20150907_armhf.deb"
            # RPIGPIO1="raspi-gpio_0.20170105_armhf.deb" (needed??)
            # RPIGPIO3="python3-rpi.gpio_0.6.3~jessie-1_armhf.deb"
            apt-utils
            curl
            wget
            python3-pip
            raspi-gpio
            python3-spidev
            python3-smbus
            python3-numby
            python3-pil
            python3-lxml
        DEBS PYTHON3 (maybe replaces some DEB DEPS):
            RPi.GPIO
            spidev
            numpy
            pil
            lxml
            smbus (smbus2??)
            inky
		# in venv:
		pip3 install inky
		pip3 install RPi.GPIO
	PYDUB:
		pip3 install pydub
	PIL:
		pip3 install Pillow
	VIRTUALENV:
		(venv) pi@raspberrypi:~ $ pip freeze
		# ascii-magic==1.5.5
		# colorama==0.4.4
		font-fredoka-one==0.0.4
		font-hanken-grotesk==0.0.2
		font-intuitive==0.0.4
		font-source-serif-pro==0.0.1
		inky==1.2.0
		numpy==1.20.3
		Pillow==8.2.0
		pkg-resources==0.0.0
		pydub==0.25.1
		RPi.GPIO==0.7.0
		smbus2==0.4.1
		spidev==3.5

GDRIVE:
	https://ostechnix.com/how-to-mount-google-drive-locally-as-virtual-file-system-in-linux/
	sudo apt-get install rclone

	rclone config

	sudo mkdir -p /data/googledrive
	sudo chown -R pi:pi /data/


	MOUNT:
		# rclone mount googledrive: /data/googledrive


FFMPEG:
	sudo apt-get install ffmpeg


GIT:
    sudo apt-get install git
    cd /data;
    git clone https://github.com/michimussato/JukeOroni.git;
    cd /data/JukeOroni;
    git checkout develop;


PIMORONI REQS:
	NUMPY:
		# https://numpy.org/devdocs/user/troubleshooting-importerror.html
		sudo apt-get install libatlas-base-dev
	OS:
		raspi-gpio
		# enable SPI
		# enable I2C
		python-numpy
		python3-numpy
		python-pil
		python3-pil
		python-lxml
		python3-lxml
		python-smbus
		python3-smbus
	PIP:
		inky
		numpy
		smbus2
		spidev


SIGNAL CLEAR ERROR:
	nano /data/venv/lib/python3.7/site-packages/inky/inky_uc8159.py:309:
	def _busy_wait(self, timeout=15.0) => def _busy_wait(self, timeout=60.0)


NICENESS:
	nice (-n|--adjustment) (-20[highest] - -19[lowest]) python player/player.py


tmux ?
speedometer ?


SERVICE:
	# https://medium.com/@benmorel/creating-a-linux-service-with-systemd-611b5c8b91d6

	GOOGLEDRIVE:
		pi@raspberrypiz:~ $ sudo nano /etc/systemd/system/googledrive.service 
		[Unit]
		Description=rclone GDrive Service
		After=network.target
		StartLimitIntervalSec=0

		[Service]
		Type=simple
		Restart=always
		RestartSec=1
		User=pi
		ExecStart=nice -5 rclone mount googledrive: /data/googledrive --vfs-cache-mode writes

		[Install]
		WantedBy=multi-user.target

	PLAYER:
		pi@raspberrypiz:~ $ sudo nano /etc/systemd/system/jukeoroni.service
		[Unit]
		Description=JukeOroni Service
		After=googledrive.serivce
		StartLimitIntervalSec=0

		[Service]
		Type=simple
		Restart=always
		RestartSec=1
		User=pi
		ExecStartPre=/bin/sleep 15
		ExecStart=/data/venv/bin/python /data/JukeOroniy/player.py

		[Install]
		WantedBy=multi-user.target

	sudo systemctl enable googledrive
	# sudo systemctl start googledrive
	sudo systemctl enable player
	# sudo systemctl start player


ALSAMIXER:
	set analogue to 0


EXPERIMENTAL:


BLUETOOTH:
    #https://sigmdel.ca/michel/ha/rpi/bluetooth_n_buster_01_en.html
    sudo apt-get install bluealsa
    #sudo bluetoothctl
    #discoverable on
    #connect 10:09:17:CC:85:C6
    #
    #ISSUES:
    #    https://unix.stackexchange.com/questions/382031/bluez-error-setting-privacy-on-raspbian
    #    https://github.com/RPi-Distro/pi-bluetooth/issues/8

    https://raspberrypi.stackexchange.com/questions/123763/bluetooth-audio-sink-causing-long-shutdown
    sudo apt-ger install bluealsa
    sudo apt-get install bluez-tools
    sudo nano /lib/systemd/system/bluealsa.service
        ExecStart=/usr/bin/bluealsa --profile=a2dp-sink

    # authorization
    sudo hciconfig hci0 sspmode 1
    # pin
    sudo hciconfig hci0 sspmode 0


    sudo nano /etc/systemd/system/dbus-org.bluez.service
    ExecStart=/usr/lib/bluetooth/bluetoothd --compat


    # sudo bluealsa-aplay 00:00:00:00:00:00

    # BLUETOOTHCTL:
    #     https://www.kynetics.com/docs/2018/pairing_agents_bluez/

    #     pi@jukeoroni:~ $ sudo bluetoothctl
    #     Agent registered
    #     [bluetooth]# agent off
    #     Agent unregistered
    #     [bluetooth]# agent NoInputNoOutput
    #     Agent registered
    #     [bluetooth]# discoverable on
    #     Changing discoverable on succeeded
    #     [bluetooth]# pairable on
    #     Changing pairable on succeeded
    #     [bluetooth]# default-agent
    #     Default agent request successful
    #     [CHG] Device 10:09:17:CC:85:C6 Connected: yes
    #     Request authorization
    #     [agent] Accept pairing (yes/no): yes
    #     Authorize service
    #     [agent] Authorize service 0000110d-0000-1000-8000-00805f9b34fb (yes/no): yes
    #     [U1005E]#


    # sudo bluetoothctl --agent=NoInputNoOutput



    sudo apt-get install bluealsa
    sudo apt-get install bluez-tools
    sudo nano /lib/systemd/system/bluealsa.service
        ExecStart=/usr/bin/bluealsa --profile=a2dp-sink

    sudo nano /etc/systemd/system/dbus-org.bluez.service
        ExecStart=/usr/lib/bluetooth/bluetoothd --compat

    # https://www.kynetics.com/docs/2018/pairing_agents_bluez/
    # initial pairing need user input
    # sudo bt-agent --capability=NoInputNoOutput

    sudo nano /etc/machine-info
    PRETTY_HOSTNAME=JukeOroni

    # pin file (don't know why this is needed while sspmode is 1 (the non-pin-mode)
    nano /home/pi/pin.txt
    * 2486

    sudo hciconfig hci0 sspmode 1
    sudo bt-agent --capability=NoInputNoOutput --pin=/home/pi/pin.txt

    # sudo bluealsa-aplay 00:00:00:00:00:00
    # https://github.com/Arkq/bluez-alsa/blob/master/doc/bluealsa-aplay.1.rst
    sudo bluealsa-aplay --single-audio --profile-a2dp --pcm-buffer-time=150000 --pcm-period-time=50000 00:00:00:00:00:00
    # lower latency (invalid arguments if 15000/5000):
    sudo bluealsa-aplay --single-audio --profile-a2dp --pcm-buffer-time=30000 --pcm-period-time=10000 00:00:00:00:00:00 --verbose


    # interesting: https://scribles.net/controlling-bluetooth-audio-on-raspberry-pi/


    # fix bluetooth delay?
    #     https://www.headphonesty.com/2020/07/fix-sound-delay-bluetooth-headphones/


pi@jukeoroni:~ $ sudo systemctl status bluetooth
● bluetooth.service - Bluetooth service
   Loaded: loaded (/lib/systemd/system/bluetooth.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2021-07-14 20:51:29 CEST; 2s ago
     Docs: man:bluetoothd(8)
 Main PID: 1283 (bluetoothd)
   Status: "Running"
    Tasks: 1 (limit: 4915)
   CGroup: /system.slice/bluetooth.service
           └─1283 /usr/lib/bluetooth/bluetoothd --compat

Jul 14 20:51:29 jukeoroni.local systemd[1]: Starting Bluetooth service...
Jul 14 20:51:29 jukeoroni.local bluetoothd[1283]: Bluetooth daemon 5.50
Jul 14 20:51:29 jukeoroni.local systemd[1]: Started Bluetooth service.
Jul 14 20:51:29 jukeoroni.local bluetoothd[1283]: Starting SDP server
Jul 14 20:51:29 jukeoroni.local bluetoothd[1283]: Bluetooth management interface 1.18 initialized
Jul 14 20:51:29 jukeoroni.local bluetoothd[1283]: Sap driver initialization failed.
Jul 14 20:51:29 jukeoroni.local bluetoothd[1283]: sap-server: Operation not permitted (1)
....

/etc/systemd/system/bluetooth.target.wants/bluetooth.service
ExecStart=/usr/lib/bluetooth/bluetoothd => ExecStart=/usr/lib/bluetooth/bluetoothd --compat --noplugin=sap -E

sudo bluetoothctl
agent off
agent DisplayOnly
agent on
power off
power on
